/**
 * Malware Detection Rules
 * Patterns for detecting malicious code, backdoors, and suspicious behavior
 */

import { Rule, Severity, ThreatType, FindingCategory } from '../../types';
import { getStandardsForThreat } from '../standards';

/**
 * Backdoor Detection Rules
 */
const backdoorRules: Rule[] = [
  {
    id: 'MAL-BACK-001',
    name: 'Potential Backdoor - Reverse Shell',
    description: 'Code pattern consistent with a reverse shell detected. This allows remote attackers to gain shell access to the system.',
    languages: ['javascript', 'typescript', 'python', 'php', 'c', 'cpp', 'csharp'],
    threatType: ThreatType.REVERSE_SHELL,
    category: FindingCategory.MALWARE,
    severity: Severity.CRITICAL,
    standards: getStandardsForThreat(ThreatType.REVERSE_SHELL),
    patterns: [
      {
        type: 'regex',
        pattern: 'socket\\.(?:connect|create_connection)\\s*\\([^)]*\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: '\\/bin\\/(?:bash|sh)\\s+-i',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'nc\\s+-e\\s+\\/bin\\/(?:bash|sh)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'subprocess\\.(?:Popen|call).*(?:bash|sh|cmd)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'dup2\\s*\\(.*(?:STDIN|STDOUT|STDERR)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'CreateProcess.*cmd\\.exe',
        flags: 'gi'
      }
    ],
    remediation: 'This code appears to implement a reverse shell backdoor. Remove immediately and investigate how this code was introduced. Audit all recent commits and contributor access.',
    enabled: true,
    tags: ['backdoor', 'reverse-shell', 'malware', 'critical']
  },
  {
    id: 'MAL-BACK-002',
    name: 'Web Shell Pattern',
    description: 'Code pattern consistent with a web shell detected. Web shells provide attackers with remote command execution via web interface.',
    languages: ['php', 'python', 'javascript', 'typescript'],
    threatType: ThreatType.BACKDOOR,
    category: FindingCategory.MALWARE,
    severity: Severity.CRITICAL,
    standards: getStandardsForThreat(ThreatType.BACKDOOR),
    patterns: [
      {
        type: 'regex',
        pattern: '\\$_(?:GET|POST|REQUEST)\\s*\\[[\'"][^\'"]+[\'"]\\s*\\].*(?:exec|system|passthru|shell_exec|eval)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'eval\\s*\\(\\s*(?:base64_decode|gzinflate|str_rot13)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'assert\\s*\\(\\s*\\$_',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'preg_replace\\s*\\([^)]*\\/e[\'"]',
        flags: 'gi'
      }
    ],
    remediation: 'This appears to be a web shell. Remove immediately. Investigate system for other compromises. Check web server logs for unauthorized access.',
    enabled: true,
    tags: ['webshell', 'backdoor', 'rce', 'critical']
  }
];

/**
 * Cryptominer Detection Rules
 */
const cryptominerRules: Rule[] = [
  {
    id: 'MAL-CRYPT-001',
    name: 'Cryptocurrency Mining Code',
    description: 'Code patterns associated with cryptocurrency mining detected. This may indicate unauthorized use of computing resources.',
    languages: ['javascript', 'typescript', 'python', 'php'],
    threatType: ThreatType.CRYPTOMINER,
    category: FindingCategory.MALWARE,
    severity: Severity.HIGH,
    standards: getStandardsForThreat(ThreatType.CRYPTOMINER),
    patterns: [
      {
        type: 'regex',
        pattern: 'coinhive|cryptoloot|coin-hive|coinimp|cryptonight',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'stratum\\+tcp:\\/\\/',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'xmrig|xmr-stak|minerd|cgminer',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'CryptoNight|RandomX|Ethash',
        flags: 'g'
      },
      {
        type: 'regex',
        pattern: 'miner\\.(?:start|stop|mine)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'hashrate|nonce.*difficulty',
        flags: 'gi'
      }
    ],
    remediation: 'Remove cryptocurrency mining code immediately. This is resource theft. Investigate how this code was introduced and review access controls.',
    enabled: true,
    tags: ['cryptominer', 'resource-abuse', 'malware']
  }
];

/**
 * Keylogger Detection Rules
 */
const keyloggerRules: Rule[] = [
  {
    id: 'MAL-KEY-001',
    name: 'Potential Keylogger',
    description: 'Code pattern consistent with keylogging behavior detected. Keyloggers capture and potentially exfiltrate user keystrokes.',
    languages: ['javascript', 'typescript', 'python', 'csharp', 'c', 'cpp'],
    threatType: ThreatType.KEYLOGGER,
    category: FindingCategory.MALWARE,
    severity: Severity.CRITICAL,
    standards: getStandardsForThreat(ThreatType.KEYLOGGER),
    patterns: [
      {
        type: 'regex',
        pattern: 'addEventListener\\s*\\([\'"]key(?:down|up|press)[\'"]',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'onkey(?:down|up|press)\\s*=',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'pynput\\.keyboard\\.Listener',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'GetAsyncKeyState|SetWindowsHookEx.*WH_KEYBOARD',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'keyboard\\.on_(?:press|release)',
        flags: 'gi'
      }
    ],
    remediation: 'This code captures keyboard input. If not intentional for legitimate purposes (like accessibility), remove immediately and investigate.',
    enabled: true,
    tags: ['keylogger', 'spyware', 'malware', 'critical']
  }
];

/**
 * Data Exfiltration Detection Rules
 */
const exfiltrationRules: Rule[] = [
  {
    id: 'MAL-EXFIL-001',
    name: 'Suspicious Data Exfiltration',
    description: 'Code pattern suggests collection and transmission of sensitive data to external endpoints.',
    languages: ['javascript', 'typescript', 'python', 'php'],
    threatType: ThreatType.DATA_EXFILTRATION,
    category: FindingCategory.MALWARE,
    severity: Severity.CRITICAL,
    standards: getStandardsForThreat(ThreatType.DATA_EXFILTRATION),
    patterns: [
      {
        type: 'regex',
        pattern: 'document\\.cookie.*(?:fetch|XMLHttpRequest|ajax|axios)',
        flags: 'gis'
      },
      {
        type: 'regex',
        pattern: 'localStorage.*(?:fetch|XMLHttpRequest|ajax)',
        flags: 'gis'
      },
      {
        type: 'regex',
        pattern: '(?:password|credit|ssn|secret).*(?:http|fetch|post)',
        flags: 'gis'
      },
      {
        type: 'regex',
        pattern: 'navigator\\.(?:credentials|clipboard).*fetch',
        flags: 'gis'
      }
    ],
    remediation: 'This code appears to collect and transmit sensitive data. Verify this is intentional and authorized. If not, remove immediately and audit data flows.',
    enabled: true,
    tags: ['exfiltration', 'data-theft', 'malware']
  }
];

/**
 * Obfuscated Code Detection Rules
 */
const obfuscationRules: Rule[] = [
  {
    id: 'MAL-OBF-001',
    name: 'Heavily Obfuscated Code',
    description: 'Code appears to be heavily obfuscated, potentially hiding malicious functionality. Legitimate code rarely requires this level of obfuscation.',
    languages: ['javascript', 'typescript', 'python', 'php'],
    threatType: ThreatType.OBFUSCATED_CODE,
    category: FindingCategory.MALWARE,
    severity: Severity.HIGH,
    standards: getStandardsForThreat(ThreatType.OBFUSCATED_CODE),
    patterns: [
      {
        type: 'regex',
        pattern: '\\\\x[0-9a-f]{2}(?:\\\\x[0-9a-f]{2}){10,}',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: '\\\\u[0-9a-f]{4}(?:\\\\u[0-9a-f]{4}){10,}',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'String\\.fromCharCode\\s*\\([^)]{50,}\\)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'atob\\s*\\([\'"][A-Za-z0-9+/=]{100,}[\'"]\\)',
        flags: 'g'
      },
      {
        type: 'regex',
        pattern: 'eval\\s*\\(\\s*(?:atob|Buffer\\.from|unescape)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: '_0x[a-f0-9]{4,}',
        flags: 'gi'
      }
    ],
    remediation: 'Heavily obfuscated code should be investigated. Deobfuscate and review the actual functionality. Consider removing if source cannot be verified.',
    enabled: true,
    tags: ['obfuscation', 'suspicious', 'malware']
  }
];

/**
 * Embedded Payload Detection Rules
 */
const payloadRules: Rule[] = [
  {
    id: 'MAL-PAYLOAD-001',
    name: 'Embedded Binary Payload',
    description: 'Large base64-encoded or hex-encoded data detected that may contain embedded malware or executable payloads.',
    languages: ['javascript', 'typescript', 'python', 'php', 'java', 'csharp'],
    threatType: ThreatType.EMBEDDED_PAYLOAD,
    category: FindingCategory.MALWARE,
    severity: Severity.HIGH,
    standards: getStandardsForThreat(ThreatType.EMBEDDED_PAYLOAD),
    patterns: [
      {
        type: 'regex',
        pattern: '[\'"][A-Za-z0-9+/]{500,}={0,2}[\'"]',
        flags: 'g'
      },
      {
        type: 'regex',
        pattern: '(?:4d5a|7f454c46|cafebabe)[0-9a-f]{100,}',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'base64\\.b64decode\\s*\\([\'"][A-Za-z0-9+/]{200,}',
        flags: 'g'
      }
    ],
    remediation: 'Large embedded binary data should be investigated. Extract and analyze the payload. If legitimate, document its purpose; otherwise, remove.',
    enabled: true,
    tags: ['payload', 'binary', 'embedded', 'malware']
  }
];

/**
 * Suspicious Network Activity Rules
 */
const networkRules: Rule[] = [
  {
    id: 'MAL-NET-001',
    name: 'Suspicious External Connection',
    description: 'Code makes connections to external IP addresses or suspicious domains. This may indicate C2 communication or data exfiltration.',
    languages: ['javascript', 'typescript', 'python', 'php', 'java', 'csharp'],
    threatType: ThreatType.SUSPICIOUS_NETWORK,
    category: FindingCategory.MALWARE,
    severity: Severity.MEDIUM,
    standards: getStandardsForThreat(ThreatType.SUSPICIOUS_NETWORK),
    patterns: [
      {
        type: 'regex',
        pattern: '(?:fetch|axios|request|http).*(?:pastebin|hastebin|ghostbin)',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: '(?:fetch|axios|request).*\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: '\\.(?:onion|bit|i2p)[\\/\\s\\\'\\"]',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'ngrok\\.io|serveo\\.net|localhost\\.run',
        flags: 'gi'
      }
    ],
    remediation: 'Review all external network connections. Verify destinations are legitimate and authorized. Block unauthorized external communications.',
    enabled: true,
    tags: ['network', 'c2', 'suspicious', 'malware']
  }
];

/**
 * Malicious Loader Detection Rules
 */
const loaderRules: Rule[] = [
  {
    id: 'MAL-LOAD-001',
    name: 'Dynamic Code Loading',
    description: 'Code dynamically loads and executes external content. This is a common technique for loading malware payloads.',
    languages: ['javascript', 'typescript', 'python', 'php'],
    threatType: ThreatType.MALICIOUS_LOADER,
    category: FindingCategory.MALWARE,
    severity: Severity.HIGH,
    standards: getStandardsForThreat(ThreatType.MALICIOUS_LOADER),
    patterns: [
      {
        type: 'regex',
        pattern: 'eval\\s*\\(\\s*(?:fetch|axios|request|http\\.get)',
        flags: 'gis'
      },
      {
        type: 'regex',
        pattern: 'document\\.write\\s*\\([\'"]<script[^>]*src=',
        flags: 'gi'
      },
      {
        type: 'regex',
        pattern: 'exec\\s*\\(\\s*(?:urllib|requests)\\.get',
        flags: 'gis'
      },
      {
        type: 'regex',
        pattern: '\\.createElement\\s*\\([\'"]script[\'"]\\)[\\s\\S]*\\.src\\s*=',
        flags: 'gim'
      }
    ],
    remediation: 'Dynamic code loading from external sources is dangerous. Use Content Security Policy. Verify all external code sources and use integrity checks.',
    enabled: true,
    tags: ['loader', 'dynamic', 'remote-code', 'malware']
  }
];

/**
 * Export all malware rules
 */
export const malwareRules: Rule[] = [
  ...backdoorRules,
  ...cryptominerRules,
  ...keyloggerRules,
  ...exfiltrationRules,
  ...obfuscationRules,
  ...payloadRules,
  ...networkRules,
  ...loaderRules
];

export default malwareRules;
