# PROMPT ‚Äì Mejora Avanzada del M√≥dulo Malware Rules
## Secure-Scan ‚Äì src/rules/malware/index.ts

Asume el rol de **Senior Malware Analyst + AppSec Engineer** con experiencia en:
- Detecci√≥n de malware est√°tico
- Supply-chain attacks
- An√°lisis de c√≥digo ofuscado
- MITRE ATT&CK
- Motores SAST empresariales

Tu objetivo es **refactorizar, ampliar y fortalecer** el m√≥dulo  
`src/rules/malware/index.ts`, que contiene reglas de detecci√≥n de malware.

---

## üéØ Objetivo General

Mejorar el sistema de reglas de malware para que sea:

- M√°s completo (m√°s reglas)
- M√°s preciso (menos falsos positivos)
- M√°s agresivo (detecci√≥n temprana)
- M√°s explicable (auditor√≠a profesional)
- Alineado a campa√±as reales de malware

Nivel requerido: **Avanzado (Regex + AST + heur√≠sticas)**

---

## üß† Evoluci√≥n del Motor de Reglas

### Requisitos clave

1. **Migrar reglas cr√≠ticas basadas solo en regex a reglas AST-aware** cuando sea posible.
2. Permitir que una regla:
   - Se active por **m√∫ltiples patrones**
   - **Incremente severidad** si hay coincidencias encadenadas
   - **Dependa de otras reglas** (correlaci√≥n)
3. Introducir un sistema de **scoring din√°mico** (`malwareScore`).

---

## ü¶† Tipos de Malware a Detectar (Reglas Dedicadas)

Implementa y/o mejora reglas para detectar:

- Reverse shells avanzados (JS, TS, PHP, Python, Node)
- Web shells ofuscados
- Cryptominers (WebAssembly, CPU hogging)
- Botnets en JavaScript
- Credential stealers
- Token stealers (JWT, OAuth, cookies, localStorage)
- Keyloggers JS
- Droppers / loaders
- Malware multi-stage

### T√©cnicas modernas a detectar

- Living-off-the-land
- Fileless malware
- Malware activado por:
  - Tiempo
  - Condiciones
  - Entorno (CI/CD, producci√≥n)
- Persistencia l√≥gica

---

## üïµÔ∏è Obfuscaci√≥n y Evasi√≥n

Las reglas deben detectar:

- Base64 + eval
- String splitting (`'e'+'v'+'a'+'l'`)
- Array mapping obfuscation
- Dead code insertion
- Anti-debugging JS
- Dynamic Function constructor
- Encoding m√∫ltiple (Base64 ‚Üí gzip ‚Üí eval)

### Implementar heur√≠sticas adicionales

- C√°lculo de **entrop√≠a**
- **Normalizaci√≥n de c√≥digo** antes de aplicar regex
- **Deobfuscaci√≥n parcial y segura** (sin ejecutar c√≥digo)

---

## üåê Lenguajes Soportados

Soporte **multi-lenguaje y espec√≠fico por lenguaje** para:

- JavaScript
- TypeScript
- Python
- PHP
- C / C++
- C#

Ejemplo:
- Web shells ‚Üí PHP, Python, JS, TS
- Reverse shells ‚Üí Node, Python, PHP, C/C++

---

## üìê Calidad Obligatoria de Cada Regla

Cada regla DEBE incluir:

- Identificador √∫nico (ej: `MAL-BACK-XXX`)
- Nombre claro
- Descripci√≥n t√©cnica
- Lenguajes soportados
- Tipo de amenaza
- Categor√≠a
- Severidad base
- Ejemplo de c√≥digo malicioso
- Ejemplo de falso positivo conocido
- Nivel de confianza
- Impacto t√©cnico
- Impacto al negocio
- Referencias MITRE ATT&CK
- CVEs reales relacionados (si existen)
- Remediaci√≥n sugerida

---

## ‚öñÔ∏è Severidad y Scoring

La severidad ser√° **mixta**:

- Parte est√°tica (definida en la regla)
- Parte din√°mica (contexto + correlaci√≥n)

Implementar `malwareScore` basado en:

- Cantidad de patrones detectados
- Nivel de ofuscaci√≥n
- Acceso a red
- Ejecuci√≥n de comandos
- Persistencia

---

## üîó Integraci√≥n con el Motor SAST

Las reglas deben poder:

- Acceder al AST
- Acceder al call graph
- Correlacionarse con otros m√≥dulos
- Analizar dependencias
- Analizar scripts npm
- Examinar carpetas como `node_modules`

---

## ‚ö° Performance y Seguridad

Implementar protecciones contra:

- ReDoS
- Loops infinitos (timeouts por regla)
- Abuso de recursos:
  - L√≠mite de coincidencias por archivo  
    (ej: si un patr√≥n aparece >10,000 veces, reducir profundidad)
- C√≥digo altamente ofuscado

---

## üìä Hallazgos y Reportes

Cada hallazgo debe incluir:

- Fragmento exacto del c√≥digo
- Patr√≥n que lo activ√≥
- Severidad final
- Malware score
- Sugerencia de remediaci√≥n
- Explicaci√≥n con **nivel auditor√≠a profesional**

---

## üß± Arquitectura del C√≥digo

Se permite y se espera que:

- Refactorices la arquitectura del m√≥dulo
- Introduzcas nuevas estructuras si es necesario
- Mantengas compatibilidad con el motor actual de Secure-Scan
- El c√≥digo siga principios **SOLID**
- Sea legible, mantenible y extensible

‚ö†Ô∏è No ejecutes c√≥digo analizado bajo ninguna circunstancia.

---

## ‚úÖ Resultado Esperado

Un m√≥dulo de reglas de malware **robusto, escalable y de nivel enterprise**, comparable a motores SAST comerciales, con detecci√≥n realista de malware moderno y m√≠nimo nivel de falsos positivos.
